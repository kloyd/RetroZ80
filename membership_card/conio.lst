                        ;; Console I/O test for TIL design.

                        ; Input Restrictions
      = 00FF            BUFFER_SIZE EQU 255

                        ;; Handy Constants
      = 000D            CR	EQU     0DH
      = 000A            LF	EQU     0AH
      = 0024            DOLLAR  EQU     24H
      = 001B            ESC     EQU     1BH
      = 0003            CTRLC   EQU     03H

                        ; Screen print calls
      = 0003            CHAR_IN EQU     03H
      = 000B            C_STAT  EQU     0BH
      = 0006            C_RAWIO EQU     06H


      = 0009            WRITESTR        EQU     9H
      = 0002            PRTCHR  EQU     02H
      = 0005            BDOS    EQU     05H

                        ;       CP/M User program space starts at Page 1.
0100                            ORG     100h

0100                    MAIN:
0100  11 4201                   LD      DE, GREET
0103  CD 3601                   CALL PUTS
0106  11 5501                   LD      DE, PROMPT
0109  CD 3601                   CALL PUTS

010C                    READING:
010C  CD 1201                   CALL INPUT
010F  C3 0C01                   JP READING

0112                    INPUT:
                                ; Loop until character available.
0112  0E 06                     LD C, C_RAWIO
0114  11 FFFF                   LD DE,FFFFh
0117  CD 0500                   CALL    BDOS
011A  B7                        OR A
011B  28 F5                     JR Z, INPUT

                                ;LD C, CHAR_IN
                                ;CALL BDOS

011D  FE 03                     CP 03H
011F  CA 2D01                   JP Z, EXIT

0122  FE 0D                     CP 0DH
0124  CA 2D01                   JP Z, EXIT

0127  57                        LD D, A
0128  5F                        LD E, A
0129  CD 3C01                   CALL PUTC
012C  C9                        RET

012D  11 5801           EXIT    LD      DE, EXITSTR
0130  CD 3601                   CALL    PUTS
                                ; CP/M Warm Boot
0133  C3 0000                   JP 0h

                        ; Print a string
0136                    PUTS:
                        ;;; Question, should we PUSH C and POP C here?
0136  0E 09                     LD C, WRITESTR
0138  CD 0500                   CALL BDOS
013B  C9                        RET

                        ; Print a character
013C                    PUTC:
013C  0E 02               LD C, PRTCHR
013E  CD 0500             CALL BDOS
0141  C9                  RET


0142  48454C4C 4F2C2049 GREET: DB "HELLO, I'M A TIL", CR, LF, DOLLAR
014A  274D2041 2054494C
0152  0D0A24
0155  3E2024            PROMPT: DB "> ", DOLLAR
0158  0D0A4B2C 20546878 EXITSTR: DB CR, LF, "K, Thx, Bye!", CR, LF, DOLLAR
0160  2C204279 65210D0A
0168  24

                        ;; Buffer at end of memory.
0169   (00FF)           BUFFER: DS BUFFER_SIZE



                                ; Need 0000 for asmx to generate correct Intel HEX.
0268   (0000)                   END 0000

BDOS               0005 E  BUFFER             0169    BUFFER_SIZE        00FF E
CHAR_IN            0003 E  CR                 000D E  CTRLC              0003 E
C_RAWIO            0006 E  C_STAT             000B E  DOLLAR             0024 E
ESC                001B E  EXIT               012D    EXITSTR            0158
GREET              0142    INPUT              0112    LF                 000A E
MAIN               0100    PROMPT             0155    PRTCHR             0002 E
PUTC               013C    PUTS               0136    READING            010C
WRITESTR           0009 E
