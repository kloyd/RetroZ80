                        ; TIL
                        ; Outer Interpreter

                        ; TIL

                        ; START/RESTART
8000                    	ORG	0x8000

8000  11 4881           START	LD	DE,RSTMSG
8003  3A C080           	LD	A,(BASE)
8006  A7                	AND	A
8007  20 08             	JR	NZ, ABORT
8009  3E 0A             	LD	A,10
800B  32 C080           	LD	(BASE),A
800E  11 5581           	LD	DE,SRTMSG
8011  31 00F0           ABORT	LD	SP,STACK
8014  D5                	PUSH	DE
8015  21 0000           	LD	HL,0
8018  22 C180           	LD	(MODE),HL
801B  FD21 9580         	LD	IY,NEXT
801F  DD21 7B80         	LD	IX,RETURN
8023  21 901F           	LD	HL,8080
8026  22 C480           	LD	(LBEND),HL
8029  01 2F80           	LD	BC,OUTER	; Effectively, Set OUTER as the next routine
802C  C3 9580           	JP	NEXT		; Call NEXT in the Inner Interpreter, which will load address of OUTER and Jump to it.


                        ; TYPE
802F                    OUTER

                        ; INLINE
802F  3180              INLINE	DW	$ + 2	;header address
8031  C5                ISTART	PUSH	BC
8032  CD 8280           	CALL	_CRLF	; Issue CR / LF on terminal for new input
8035  21 4481           	LD	HL, LBADD	; Buffer
8038  22 C280           	LD	(LBP), HL
803B  06 80             	LD	B, LENGTH
803D  36 20             CLEAR	LD	(HL), ASPACE
803F  23                	INC	HL
8040  10 FB             	DJNZ	CLEAR
8042  2E 00             ZERO	LD	L,0
8044  CD BA80           INKEY	CALL	_KEY
8047  FE 18             	CP	LINEDEL		; CTRL-X is Line Delete
8049  20 05             	JR	NZ,TSTBS
804B  CD BD80           	CALL	_ECHO
804E  18 E1             	JR ISTART
8050  FE 08             TSTBS	CP	BKSP		; backspace CTRL-H
8052  20 0B             	JR	NZ, TSTCR
8054  2B                	DEC	HL
8055  FA 4280           	JP	M,ZERO
8058  36 20             	LD	(HL), ASPACE
805A  CD BD80           ISSUE	CALL	_ECHO
805D  18 E5             	JR	INKEY
805F  FE 0D             TSTCR	CP	CR


                        ; ASPACE

                        ; TOKEN

                        ; ?SEARCH

                        ; ABSENT?
                        ; - NO -> ?EXECUTE -> ASPACE
                        ; - YES -> NUMBER

                        ; ?EXECUTE

                        ; ?NUMBER

                        ; INVALID NUMBER?
                        ; NO -> ASPACE
                        ; YES -> QUESTION

                        ; QUESTION
8061                    QUESTION
8061  6380              	DW	$+2
8063  2A 4681           	LD 	HL,(DP)
8066  23                	INC 	HL
8067  CB7E              	BIT	7,(HL)	; IF BIT SET, A TERMINATOR
8069  28 06             	JR	Z,ERROR	;NOT SET ERROR
806B  11 8580           	LD	DE,OK
806E  D5                	PUSH	DE
806F  FDE9              	JP	(IY)
8071  CD 8280           ERROR	CALL	_CRLF
8074  FD21 7B80         	LD	IY,RETURN
8078  C3 8180           	JP	_TYPE
807B  11 8380           RETURN	LD	DE, QMSG
807E  C3 8880           	JP	_PATCH

                        ; GOTO TYPE


                        ; Internals
8081  00                _TYPE	DB	0
8082  00                _CRLF	DB	0
8083  3F00              QMSG	DB	'?', 0
8085  4F4B00            OK	DB	'OK',0

                        ; PATCH internal routine.
8088  00                _PATCH	DB	0

                        ; Inner Interpreter

8089  8B80              SEMI	DW	$ + 2
808B  DD4E 00           	LD	C,(IX+0)
808E  DD23              	INC	IX
8090  DD46 00           	LD	B,(IX+0)
8093  DD23              	INC	IX
8095  0A                NEXT	LD	A,(BC)
8096  6F                	LD	L,A
8097  03                	INC	BC
8098  0A                	LD	A,(BC)
8099  67                	LD	H,A
809A  03                	INC	BC
809B  5E                RUN	LD	E,(HL)
809C  23                	INC	HL
809D  56                	LD	D,(HL)
809E  23                	INC	HL
809F  EB                	EX	DE,HL
80A0  E9                	JP	(HL)

80A1  DD2B              COLON	DEC	IX
80A3  DD70 00           	LD	(IX+0),B
80A6  DD2B              	DEC	IX
80A8  DD71 00           	LD	(IX+0),C
80AB  4B                	LD	C,E
80AC  42                	LD	B,D
80AD  FDE9              	JP	(IY)

                        ; EXECUTE primitive needs a dictionary entry for defining words.
                        ; This is a model for all other Primitive words that will be added to the dictionary
                        ;
80AF  07455845          	DB	7,'E','X','E'	; Header for dictionary search
80B3  0000              	DW	0		; Link address 0000 == End of Linked List.
80B5  B780              EXECUTE DW	$ + 2		; Address of EXECUTE.
80B7  E1                	POP	HL		; primitive code.
80B8  18 E1             	JR	RUN

                        ; ***
                        ; Machine Specific routines
                        ; KEY
                        ;; Very simplistic using Z80 simulator terminal I/o
80BA  DB FF             _KEY	IN	A,(FFH)
80BC  C9                	RET

                        ; ECHO
80BD  D3 FF             _ECHO	OUT	(FFh), A
80BF  C9                	RET



                        ; Constants
                        ;
      = 0018            LINEDEL	EQU	18H	; ctrl-x line delete
      = 0020            ASPACE	EQU	20h	; space
      = 0008            BKSP	EQU	08h	; ctrl-H backspace
      = 000D            CR	EQU	0Dh	; carriage return

                        ; Variables
80C0  00                BASE	DB	0	; BASE for restart/warm start
80C1  00                MODE	DB	0	; MODE
80C2  0000              LBP	DW	0 	; line buffer pointer
      = 0080            LENGTH	EQU	128	; buffer length
80C4   (0080)           LBEND	DS	128	; text input buffer
8144  0000              LBADD	DW	0

                        ; Dictonary pointer
8146  0000              DP	DW	0

                        ; Strings
8148  2054494C 20524553 RSTMSG	DB	' TIL RESTART', 0
8150  54415254 00
8155  2057454C 434F4D45 SRTMSG	DB	' WELCOME TO RETRO TIL',0
815D  20544F20 52455452
8165  4F205449 4C00

                        ; Stack grows down... set this at F000
F000                    	ORG	0xF000
                        ;STK	DS	255
F000  00                STACK	DB	0





ABORT              8011    ASPACE             0020 E  BASE               80C0
BKSP               0008 E  CLEAR              803D    COLON              80A1
CR                 000D E  DP                 8146    ERROR              8071
EXECUTE            80B5    INKEY              8044    INLINE             802F
ISSUE              805A    ISTART             8031    LBADD              8144
LBEND              80C4    LBP                80C2    LENGTH             0080 E
LINEDEL            0018 E  MODE               80C1    NEXT               8095
OK                 8085    OUTER              802F    QMSG               8083
QUESTION           8061    RETURN             807B    RSTMSG             8148
RUN                809B    SEMI               8089    SRTMSG             8155
STACK              F000    START              8000    TSTBS              8050
TSTCR              805F    ZERO               8042    _CRLF              8082
_ECHO              80BD    _KEY               80BA    _PATCH             8088
_TYPE              8081
